import torch
import tensorflow as tf
from keras._tf_keras.keras.utils import get_custom_objects
from transformers import TFBertModel, BertTokenizer, BertForSequenceClassification

class IntentModel():

    def __init__(self):
        self.MAX_LENGTH = 32
        self.classes = ['Question', 'Search', 'New Calendar', 'Read Calendar', 'Send Emails', 'Read Emails', 'Call contact', 'new contact', 'weather', 'open app', 'Read notification', 'Translation', 'Rejection', 'Acceptance', 'greetings', 'alarm']
        self.tokenizer =  BertTokenizer.from_pretrained("aubmindlab/bert-base-arabertv02-twitter")

        get_custom_objects().update({'TFBertModel': TFBertModel})
        self.model = tf.keras.models.load_model('./intent model/intent_model.h5', custom_objects={'TFBertModel': TFBertModel})
        self.model.save('path_to_save_tf_model')
        # self.model = BertForSequenceClassification.from_pretrained('./intent model/intent_model.h5')
        # self.device = torch.device('cuda') if torch.cuda.is_available() else torch.device('cpu')
        # self.model.to(self.device)
    
    def get_intent(self, txt):
        
        ids = self.tokenizer(txt, return_tensors="tf", padding='max_length', max_length=self.MAX_LENGTH, truncation=True)['input_ids']#.to(self.device)
        pred = self.model.predict(ids)
        index = tf.math.argmax(pred[0])

        return self.classes[index]

m = IntentModel()
print(m.get_intent("الجو عامل ايه النهردة"))